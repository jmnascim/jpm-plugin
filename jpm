// ==UserScript==
// @name         JaguarFeedbackButton
// @namespace    http://tampermonkey.net/
// @version      0.3.0
// @run-at       document-end
// @downloadURL  https://gitlab.aws.dev/wssousa/jaguarfeedbackgreasymonkey/-/raw/master/JaguarFeedbackButton.user.js
// @updateURL    https://gitlab.aws.dev/wssousa/jaguarfeedbackgreasymonkey/-/raw/master/JaguarFeedbackButton.user.js
// @description  Add Jaguar Feedback button on SFDC to speedup partner feedbacks
// @author       jmnasim
// @match        https://aws-crm.lightning.force.com/*
// @grant        GM_getValue
// @grant        GM_setValue
// ==/UserScript==

(function() {
    'use strict';

    const JAGUAR_COMMENT = `[DO NOT DISCLOSE - INTERNAL USE ONLY]
This rating is associated to a mechanism we are implementing with LATAM CSC and LATAM Partner Management SA teams to work closer with our partners and deliver internal feedback about partner technical readiness and presence in key opportunities where they are the primary partner in SFDC. #JFT

Name of the SA from the Partner:
Growth Area: [Behavior, Technical Preparation, Technical Explanation] (choose 1)
Open Comments - Achieved outcome:
`;

    const SELECTORS = {
        UTILITY_BAR: 'body > div.desktop.container.forceStyle.oneOne.navexDesktopLayoutContainer.lafAppLayoutHost.forceAccess.tablet > div.viewport > section > div.flexipagePage > div.oneUtilityBarContainer.oneUtilityBar',
        UTILITY_BAR_UL: 'body > div.desktop.container.forceStyle.oneOne.navexDesktopLayoutContainer.lafAppLayoutHost.forceAccess.tablet > div.viewport > section > div.flexipagePage > div.oneUtilityBarContainer.oneUtilityBar > div.oneUtilityBar.slds-utility-bar_container.oneUtilityBarContent > ul',
        COMMENT_FIELD_AUX: 'body > div.desktop.container.forceStyle.oneOne.navexDesktopLayoutContainer.lafAppLayoutHost.forceAccess.tablet > div.DESKTOP.uiContainerManager > div > div.panel.slds-modal.slds-fade-in-open > div',
        COMMENT_FIELD: 'forcegenerated-detailpanel_awspartnerrating__c___012000000000000aaa___full___create___recordlayout2 > records-record-layout-block > slot > records-record-layout-section > div > div > div > slot > records-record-layout-row:nth-child(4) > slot > records-record-layout-item:nth-child(1) > div > span > slot > records-record-layout-text-area > lightning-textarea > div.slds-form-element__control.slds-grow.textarea-container > textarea',
        COMMENT_FIELD_SPACE: 'forcegenerated-detailpanel_awspartnerrating__c___012000000000000aaa___full___create___recordlayout2 > records-record-layout-block > slot > records-record-layout-section > div > div > div > slot > records-record-layout-row:nth-child(4) > slot > records-record-layout-item:nth-child(2)'
    };

    const URLS = {
        OPPORTUNITY: /https:\/\/aws-crm\.lightning\.force\.com\/lightning\/r\/Opportunity\/[a-zA-Z0-9]{18}\/view/,
        PARTNER_RATING: /https:\/\/aws-crm\.lightning\.force\.com\/lightning\/o\/AWSPartnerRating__c\/new\?backgroundContext.*/
    };

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function waitForElement(selector, parent = document) {
        let element = parent.querySelector(selector);
        if (element) return element;

        return new Promise(resolve => {
            const observer = new MutationObserver(() => {
                element = parent.querySelector(selector);
                if (element) {
                    observer.disconnect();
                    resolve(element);
                }
            });
            observer.observe(parent, { childList: true, subtree: true });
        });
    }

    function createButton() {
        const li = document.createElement('li');
        const div = document.createElement('div');
        const button = document.createElement('button');
        const span = document.createElement('span');

        li.id = 'jaguarFeedback';
        span.textContent = 'Jaguar Feedback';
        li.appendChild(div);
        div.appendChild(button);
        button.appendChild(span);

        li.classList.add('slds-utility-bar__item', 'slds-truncate');
        div.classList.add('flexipageComponent', 'slds-utility-bar__item', 'oneUtilityBarItem');
        button.classList.add('slds-utility-bar__action', 'slds-button', 'uiButton');

        return { li, button };
    }

    function handleJaguarClick(feedbackURL, jaguarFeedbackOut) {
        jaguarFeedbackOut.timestamp = Date.now();
        GM_setValue('JaguarFeedback', jaguarFeedbackOut);
        window.open(feedbackURL, '_self');
    }

    async function handleOpportunityPage() {
        const { li, button } = createButton();
        const divUtility = await waitForElement(SELECTORS.UTILITY_BAR);
        const ul = await waitForElement(SELECTORS.UTILITY_BAR_UL);

        ul.insertBefore(li, ul.lastElementChild);

        const oppId = location.href.split('/')[6];
        const jaguarFeedbackOut = { opp: oppId, try: 1, step: 1 };
        const backgroundURL = encodeURIComponent(location.href.replace('https://aws-crm.lightning.force.com', ''));
        const feedbackURL = `https://aws-crm.lightning.force.com/lightning/o/AWSPartnerRating__c/new?backgroundContext=${backgroundURL}`;

        button.addEventListener('click', () => handleJaguarClick(feedbackURL, jaguarFeedbackOut));
    }

    async function handlePartnerRatingPage() {
        const commentFieldAux = await waitForElement(SELECTORS.COMMENT_FIELD_AUX);
        const commentField = await waitForElement(SELECTORS.COMMENT_FIELD, commentFieldAux);
        const commentFieldSpace = await waitForElement(SELECTORS.COMMENT_FIELD_SPACE, commentFieldAux);

        commentFieldSpace.style.display = 'none';
        commentField.parentElement.style.paddingLeft = '16%';
        commentField.style.height = '245px';
        commentField.value = JAGUAR_COMMENT;
    }

    function init() {
        const jaguarFeedbackIn = GM_getValue('JaguarFeedback', '');
        const nowTS = Date.now();

        if (jaguarFeedbackIn && nowTS - jaguarFeedbackIn.timestamp > 60000) {
            console.log('Jaguar Feedback Helper took too long, stopping for precaution');
            GM_setValue('JaguarFeedback', '');
        } else if (jaguarFeedbackIn && jaguarFeedbackIn.step === 1 && URLS.PARTNER_RATING.test(location.href)) {
            handlePartnerRatingPage();
        }

        let lastPath = location.pathname;
        let lastQuery = location.search;

        const checkURLChange = async () => {
            if (lastPath !== location.pathname || lastQuery !== location.search) {
                lastPath = location.pathname;
                lastQuery = location.search;

                if (URLS.OPPORTUNITY.test(location.href)) {
                    await handleOpportunityPage();
                } else {
                    const jaguarFeedback = document.getElementById('jaguarFeedback');
                    if (jaguarFeedback) jaguarFeedback.remove();
                }
            }
        };

        setInterval(checkURLChange, 500);
    }

    init();
})();
